#define BLYNK_TEMPLATE_ID "TMPL6gxKuWvWX"
#define BLYNK_TEMPLATE_NAME "SERVO MOTOR WITH ESP 32 PHONE"
#define BLYNK_AUTH_TOKEN "CY9R3RlWisrlnm-LYmilIkEbOM3ukKot"

#include <ESP32Servo.h>
#include <WiFi.h>
#include <WiFiClient.h>
#include <BlynkSimpleEsp32.h>

// You should get Auth Token in the Blynk App.
// Go to the Project Settings (nut icon).
char auth[] = "CY9R3RlWisrlnm-LYmilIkEbOM3ukKot";

// Your WiFi credentials.
// Set password to "" for open networks.
char ssid[] = "Wokwi-GUEST";
char pass[] = "";

Servo servo[8];

int finger = 0;
int slot = 0;
int currentPosition[8];
int recordPosition[10][8];
int interval = 10;
int joystick_x = 0;
int joystick_y = 0;
bool isrecorded[10];
bool protract_button = 0;
bool retract_button = 0;
bool left_button = 0;
bool right_button = 0;
bool record_button = 0;
bool replay_button = 0;
bool exit_button = 0;
bool reset_button = 0;
bool angle_changing = 0;
bool confirm_slot = 0;

BLYNK_WRITE(V0){ protract_button = param.asInt(); } // Protract
BLYNK_WRITE(V1){ retract_button = param.asInt(); } // Retract
BLYNK_WRITE(V2){ left_button = param.asInt(); } // Left
BLYNK_WRITE(V3){ right_button = param.asInt(); } // Right
BLYNK_WRITE(V4){ exit_button = param.asInt(); } // Exit
BLYNK_WRITE(V5){ reset_button = param.asInt(); } // Reset
BLYNK_WRITE(V6){ replay_button = param.asInt(); } // Replay
BLYNK_WRITE(V7){ record_button = param.asInt(); } // Record
BLYNK_WRITE(V8){ finger = param.asInt(); } // Finger select menu
BLYNK_WRITE(V9){ joystick_x = param.asInt(); } // joystick for x axis
BLYNK_WRITE(V10){ finger = param.asInt(); } // Finger select slider
BLYNK_WRITE(V11){ joystick_y = param.asInt(); } // joystick for y axis
BLYNK_WRITE(V13){ slot = param.asInt(); } // Slot select
BLYNK_WRITE(V14){ confirm_slot = param.asInt(); } // Confirm slot




void originalposition();
void replay(int slot);
void record(int slot);
void exitProgram();
void protract(int finger, int joystick);
void retract(int finger, int joystick);
void left(int finger, int joystick);
void right(int finger, int joystick);

void setup() {
  Serial.begin(115200);
  Blynk.begin(auth, ssid, pass);
    Serial.println("1");

    servo[0].attach(34);
    servo[1].attach(35);
    servo[2].attach(32);
    servo[3].attach(33);
    servo[4].attach(25);
    servo[5].attach(26);
    servo[6].attach(27);
    servo[7].attach(14);
  for (int i = 0; i < 10; i++){
    isrecorded[i] = false;
  }
  originalposition();
}

void loop() {
  //Serial.println("2");
  Blynk.run();
  if (record_button){     //record button is pushed
    while(slot == 0){};        //wait if user haven't selected any slot
    while(confirm_slot == 0){};
    record(slot);
  }else if(replay_button){
    Serial.println("3");
    while(slot == 0){};
    while(confirm_slot == 0){};
    replay(slot);
  }else if(reset_button){
    Serial.println("4");
    originalposition();
  }else if(exit_button){
    exitProgram();
  }

  if (finger != 0){
    if(protract_button){
      protract(finger, 0);
    }else if(retract_button){
      retract(finger, 0);
    }else if(left_button){
      left(finger, 0);
    }else if(right_button){
      right(finger, 0);
    }

    if(joystick_y > 0){
      protract(finger, 10 - joystick_y); //if joystick move slightly, lower value assigned, passing value larger
    }else if(joystick_y < 0){
      retract(finger, 10 + joystick_y);
    }else if(joystick_x > 0){
      right(finger, 10 - joystick_x);
    }else if(joystick_x < 0){
      left(finger, 10 + joystick_x);
    }

  }

  

  if(angle_changing){
  for (int i = 0; i < 8; i++){
    servo[i].write(currentPosition[i]);      //rotate servo motor
  }
  angle_changing = 0;
  }
}


void originalposition(){
  for (int j=0; j<4; j++){ //just easier for angle setting
    currentPosition[j] = 0;    //all the left servo become 0
    currentPosition[j+4] = 180;  //all the right servo become 180
  }
  angle_changing = 1;         //synchronize to servo motors
  return;
}

void protract(int finger, int joystick){
  currentPosition[finger] = currentPosition[finger] + (interval - joystick);    //passing value is smaller so the increase will be larger
  currentPosition[finger + 4] = currentPosition[finger + 4] - (interval - joystick) ;
  angle_changing = 1;
  delay(500);                                         //avoid too fast changing
  return;
}

void retract(int finger, int joystick){
  currentPosition[finger] = currentPosition[finger] - (interval - joystick);
  currentPosition[finger + 4] = currentPosition[finger + 4] + (interval - joystick);
  angle_changing = 1;
  delay(500);
  return;
}

void left(int finger, int joystick){
  currentPosition[finger] = currentPosition[finger] + (interval - joystick);
  currentPosition[finger + 4] = currentPosition[finger + 4] + (interval - joystick);
  angle_changing = 1;
  delay(500);
  return;
}

void right(int finger, int joystick){
  currentPosition[finger] = currentPosition[finger] - (interval - joystick);
  currentPosition[finger + 4] = currentPosition[finger + 4] - (interval - joystick);
  angle_changing = 1;
  delay(500);
  return;
}

void replay(int slot){
  while (isrecorded[slot-1]){     //make sure slot have recorded
  originalposition();
  for (int i = 0; i < 8; i++){
    servo[i].write(recordPosition[slot-1][i]);    //minus 1 because the input 1 will be slot[0]
  }
  break;
  }
  slot = 0;
  return;
}


void record(int slot){
  for (int i = 0; i < 8; i++){
    recordPosition[slot-1][i] = currentPosition[i];   //record current position in slot-1
  }
  isrecorded[slot-1] = true;
  slot = 0;
  return;
}

void exitProgram(){
  int finger = 0;         //no finger is not chosen so the up/down/left/right and joystick is unabled
  originalposition();
  return;
}
